<html>
  <head><title>OpenLayers KML Example</title>
  
  <div id="mapdiv"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openlayers/2.11/lib/OpenLayers.js"></script>      
  <script src="http://code.jquery.com/jquery-3.1.1.min.js"></script>
  <link rel="stylesheet" href="https://openlayers.org/en/v5.3.0/css/ol.css" type="text/css">
  <script src="https://openlayers.org/en/v5.3.0/build/ol.js" type="text/javascript"></script>

  <script>
test();

    map = new OpenLayers.Map("mapdiv");
    map.addLayer(new OpenLayers.Layer.OSM());
	
       console.log("hello");
     //now you can use any property of your feature to identify the different colors
     //I am using the ID property of your data just to demonstrate
	 var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
            renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;
       var colors = ["red", "green", "blue"];
            var context = {
                getColor: function(feature) {
				var region=1;
				for (var i = 0, len = array_temp.length; i < len; i++) {
					if (feature.data.name ==array_temp[i].name){
					var region = 2;
					} 
					}
				
						
                    return colors[region];
                },
                
            };
            var template = {
                
                fillColor: "${getColor}" // using context.getColor(feature)
            };
            var style = new OpenLayers.Style(template, {context: context});

	

    var kmllayer = new OpenLayers.Layer.Vector("KML", {
			styleMap : new OpenLayers.StyleMap(style),
            strategies: [new OpenLayers.Strategy.Fixed()],
            protocol: new OpenLayers.Protocol.HTTP({
                url: "./map.kml",
				
                format: new OpenLayers.Format.KML({
					
                    extractStyles: false, 
                    extractAttributes: true,
                    maxDepth: 2
                })
            })
			
        });
		




    map.addLayer(kmllayer);
	
   setTimeout(function(){ 

        console.log(kmllayer.getFeatureByFid("population_data_per_block.1"));
    }, 3000);  
  
	
    //Set start centrepoint and zoom
    //TODO: Is it possible to just zoom to extents of KML objects instead?
    
    var lonLat = new OpenLayers.LonLat( 22.944420 , 40.640064 )
          .transform(
            new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
            map.getProjectionObject() // to Spherical Mercator Projection
          );
    var zoom=14;
    map.setCenter (lonLat, zoom);  
    
    //Add a selector control to the kmllayer with popup functions
    var controls = {
      selector: new OpenLayers.Control.SelectFeature(kmllayer, { onSelect: createPopup, onUnselect: destroyPopup })
    };
	
	
	
    function createPopup(feature) {
      feature.popup = new OpenLayers.Popup.FramedCloud("pop",
          feature.geometry.getBounds().getCenterLonLat(),
          null,
        '<div class="markerContent">'+feature.attributes.description
        + '<iframe name="votar" style="display:none;"></iframe>'
         +'<form action="select.php" method="POST" id="form" name="form" target="votar">'
          +'Αρθμός Θέσεων Στάθμευσης:<br>'
            +'<input type="text" name="number_p" value="Mickey"><br>'
             + 'Καμπύλη Ζήτησης:<br>'
              +  '<input type="text" name="lastname" value="Mouse"><br><br>'
			   +	'<input type="hidden" value="'+ feature.attributes.name + '"' + 'name="extra">'
                +   '<input type="submit" value="Submit">'
				
				 +    '</form>',
          null,
          true,
          function() { controls['selector'].unselectAll(); }
      );
      //feature.popup.closeOnMove = true;
      map.addPopup(feature.popup);
    }

    function destroyPopup(feature) {
      feature.popup.destroy();
      feature.popup = null;
    }
	map.addControl(controls['selector']);
    controls['selector'].activate();
	
var array_temp;

	function test() {
    
            xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
			array_temp=JSON.parse(xmlhttp.response);
            }
        };
       xmlhttp.open("GET","test.php",true);
       xmlhttp.send();
	   
    }
/* setTimeout(function(){ 
	for (var i = 0, len = array_temp.length; i < len; i++) {
	console.log(kmllayer.getFeatureByFid(array_temp[i].name));
	kmllayer.getFeatureByFid(array_temp[i].name).style;
	}
	
    }, 4000);  
setTimeout(function(){ 
kmllayer.redraw();
	
    }, 6000);  
*/
	</script>
	</head>
<body >
<script>




<?php
include 'WORKING_KENTROIDES.php';
error_reporting(E_ERROR | E_PARSE);

// your config
$dbHost = 'localhost';
$dbUser = 'root';
$dbPass = '';
$dbName = 'map_data';
$maxRuntime = 8; // less then your max script execution limit
$id=0;

$deadline = time()+$maxRuntime; 

$con = mysqli_connect($dbHost, $dbUser, $dbPass) OR die('connecting to host: '.$dbHost.' failed: '.mysqli_error($con));
        $db_selected = mysqli_select_db($con,$dbName) OR $sql = "CREATE DATABASE map_data";
        if (!$db_selected){
        if (mysqli_query($con, $sql)) {
            console.log( "Database created successfully");
        	mysqli_select_db($con,$dbName);
        } else {
            console.log( "Error creating database: " . mysqli_error($con));
        }
        }
		$sql="DROP TABLE IF EXISTS `coordinates`";
		mysqli_query($con, $sql);

        $sql = "CREATE TABLE coordinates (
        id int(11) PRIMARY KEY,
        name varchar(100) COLLATE utf8_unicode_ci NOT NULL,
        coords varchar(8000) NOT NULL,
        description varchar(999) NOT NULL,
        centroid varchar(999) NULL,
        number_parking int(11),
		region float(5)
        )ENGINE=INNODB CHARACTER SET ascii COLLATE ascii_general_ci";
        if (mysqli_query($con, $sql)) {
            console.log( "Coordinates table created successfully");
        	mysqli_select_db($con,$dbName);
        } else {
            console.log( "Error creating Table: " . mysqli_error($con));
        }
		
		
		$sql="CREATE TABLE IF NOT EXISTS `Availability` (
		`Time` SMALLINT UNSIGNED NOT NULL,
		`Region` SMALLINT,
		`Value` FLOAT NOT NULL,
		PRIMARY KEY (`Time`,`Region`)
		)ENGINE=INNODB CHARACTER SET ascii COLLATE ascii_general_ci";
		if (mysqli_query($con, $sql)) {
            console.log("Availability table created succesfully");
        	mysqli_select_db($con,$dbName);
        } else {
            console.log( "Error creating Table: " . mysqli_error($con));
        }
		
		
		
		
			
		

try {
    $con = new PDO("mysql:host=$dbHost;dbname=$dbName", $dbUser, $dbPass);
    // set the PDO error mode to exception
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
	


/**** Configuration ****/
// The KML file you want to process
$kml_file = 'map.kml';
// The name of the table to create in the SQL file
$table_name = 'dataset';
// Whether to escape the ampersands in the KML; shp2kml doesn't do it
// Change only if you're having problems
$auto_escape = true;
/***************************/
/**** Meat and Potatoes ****/
/***************************/
$kml = file_get_contents($kml_file);
if ($auto_escape)
  $kml = str_replace('&', '&amp;', $kml);
$places_xml = simplexml_load_string($kml);
$headings = array('NAME', 'LONGITUDE', 'LATITUDE','COORDINATES');
$headings_mapped = false;
$data = array();
foreach ($places_xml->Document->Folder[0]->Placemark as $place) {
if ($place->MultiGeometry->Polygon->outerBoundaryIs->LinearRing->coordinates == NULL)
	{
	$temp=$place->MultiGeometry->MultiGeometry->Polygon->outerBoundaryIs->LinearRing->coordinates;
	} else
	{
	$temp=$place->MultiGeometry->Polygon->outerBoundaryIs->LinearRing->coordinates;
	}
  $row = array(
    $place->name,
    $temp,
	$place->description
  );
   
  

  $desc_bits = explode('</tr>', $place->description);
  array_pop($desc_bits);
  array_shift($desc_bits);
  foreach ($desc_bits as $item) {
    if (empty($item))
      continue;
    $item_bits = explode('</td>', $item);
    $item_head = trim(strip_tags($item_bits[0]));
    $item_value = trim(strip_tags($item_bits[1]));
    if (!$headings_mapped) {
      if (strtolower($item_head) != 'name')
        $headings[] = $item_head;
    }
    if (strtolower($item_head) != 'name')
      $row[] = $item_value;
  }
  $headings_mapped = true;
  $data[] = $row;
}



$con->beginTransaction();
foreach ($data as $row) {
$con->exec("INSERT INTO `coordinates` (`id`,`name`,`coords`,`description`) VALUES ('$id','$row[0]','$row[1]','$row[2]')");
$id+=1;
}
$con->commit();
console.log("New records created successfully");
}
catch(PDOException $e)
    {
    // roll back the transaction if something failed
    $con->rollback();
    console.log( "Error: " . $e->getMessage());
    }
updateCentroids();
$con = null;


?>






</script>

</body>

</html>
    