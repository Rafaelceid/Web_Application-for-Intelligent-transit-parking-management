<html>
    <head>
	<link rel="stylesheet" href="https://openlayers.org/en/v5.3.0/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>

        <title></title>
        <script src="http://openlayers.org/api/OpenLayers.js"></script>
        <script type="text/javascript">



            var lat=40.736851;
            var lon=22.920227;
            var zoom=15;
            var map;

            function init(){
                map = new OpenLayers.Map ("map", {
                controls:[
                    new OpenLayers.Control.Navigation(),
                    new OpenLayers.Control.PanZoomBar(),
                    new OpenLayers.Control.LayerSwitcher(),
                    new OpenLayers.Control.Attribution()],
                    maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
                    maxResolution: 156543.0399,
                    numZoomLevels: 19,
                    units: 'm',
                    projection: new OpenLayers.Projection("EPSG:900913"),
                    displayProjection: new OpenLayers.Projection("EPSG:4326"),

                } );


                map.addLayer(new OpenLayers.Layer.OSM());

                var lonLat = new OpenLayers.LonLat(lon, lat).transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection("EPSG:900913"));

                map.setCenter (lonLat, zoom);




				var layer2 = new OpenLayers.Layer.Vector("Test", {
    projection: new OpenLayers.Projection("EPSG:4326"),
    strategies: [new OpenLayers.Strategy.Fixed()],
    protocol: new OpenLayers.Protocol.HTTP({
        url: "map.kml",
        format: new OpenLayers.Format.KML({
            extractStyles: true,
            extractAttributes: true
        })
    })
});

				map.addLayer(layer2);


            }
        </script>

    </head>
    <body onload="init()">
        <div id="map" class="smallmap"></div>
        </div>
<?php
/**** Configuration ****/
// The KML file you want to process
$kml_file = 'map.kml';
// The name of the table to create in the SQL file
$table_name = 'dataset';
// Whether to escape the ampersands in the KML; shp2kml doesn't do it
// Change only if you're having problems
$auto_escape = true;
/***************************/
/**** Meat and Potatoes ****/
/***************************/
$kml = file_get_contents($kml_file);
if ($auto_escape)
  $kml = str_replace('&', '&amp;', $kml);
$places_xml = simplexml_load_string($kml);
$headings = array('NAME', 'LONGITUDE', 'LATITUDE','COORDINATES');
$headings_mapped = false;
$data = array();
foreach ($places_xml->Document->Folder[0]->Placemark as $place) {
  $row = array(
    $place->name,
    $place->MultiGeometry->Polygon->outerBoundaryIs->LinearRing->coordinates
  );
  $desc_bits = explode('</tr>', $place->description);
  array_pop($desc_bits);
  array_shift($desc_bits);
  foreach ($desc_bits as $item) {
    if (empty($item))
      continue;
    $item_bits = explode('</td>', $item);
    $item_head = trim(strip_tags($item_bits[0]));
    $item_value = trim(strip_tags($item_bits[1]));
    if (!$headings_mapped) {
      if (strtolower($item_head) != 'name')
        $headings[] = $item_head;
    }
    if (strtolower($item_head) != 'name')
      $row[] = $item_value;
  }
  $headings_mapped = true;
  $data[] = $row;
}
$output = '';
$output = 'CREATE TABLE IF NOT EXISTS `' . $table_name . "` (\n";
$output .= "\t`id` int(11) NOT NULL AUTO_INCREMENT,\n";
$output .= "\t`name` varchar(100) COLLATE utf8_unicode_ci NOT NULL,\n";
$output .= "\t`lat` double NOT NULL,\n";
$output .= "\t`lng` double NOT NULL,\n";
$output .= "\t`coords` int(20) NOT NULL AUTO_INCREMENT,\n";
$output .= "\t`coords` int(20) NOT NULL AUTO_INCREMENT,\n";
$fields = array();
foreach (array_slice($headings, 4) as $head) {
  $output .= "\t`" . $head . "` text COLLATE utf8_unicode_ci NOT NULL,\n";
  $fields[] = '`' . $head . '`';
}
$output .= "\tPRIMARY KEY (`id`)\n";
$output .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci AUTO_INCREMENT=1;\n\n";
$output .= 'INSERT INTO `' . $table_name . '` (`name`, `lat` ,`lng`,`coords` ' . implode(', ', $fields) . ") VALUES\n";
$values = array();
foreach ($data as $row) {

  $values[] = '("' . implode('", "', $row) . '")';
}
$output .= implode(",\n", $values);
$output .= ";\n";
file_put_contents(str_replace('.kml', '.sql', $kml_file), $output);
?>




<?php

// your config
$filename = 'omonoia.sql';
$dbHost = 'localhost';
$dbUser = 'root';
$dbPass = '';
$dbName = 'map_data';
$maxRuntime = 8; // less then your max script execution limit


$deadline = time()+$maxRuntime; 
$progressFilename = $filename.'_filepointer'; // tmp file for progress
$errorFilename = $filename.'_error'; // tmp file for erro

$con = mysqli_connect($dbHost, $dbUser, $dbPass, $dbName) OR die('connecting to host: '.$dbHost.' failed: '.mysqli_error($con));
mysqli_select_db($con,$dbName) OR die('select db: '.$dbName.' failed: '.mysqli_error($con));

($fp = fopen($filename, 'r')) OR die('failed to open file:'.$filename);

// check for previous error
if( file_exists($errorFilename) ){
    die('<pre> previous error: '.file_get_contents($errorFilename));
}

// activate automatic reload in browser
echo '<html><head> <meta http-equiv="refresh" content="'.($maxRuntime+2).'"><pre>';

// go to previous file position
$filePosition = 0;
if( file_exists($progressFilename) ){
    $filePosition = file_get_contents($progressFilename);
    fseek($fp, $filePosition);
}

$queryCount = 0;
$query = '';
while( $deadline>time() AND ($line=fgets($fp, 1024000)) ){
    if(substr($line,0,2)=='--' OR trim($line)=='' ){
        continue;
    }

    $query .= $line;
    if( substr(trim($query),-1)==';' ){
        if( !mysqli_query($con,$query) ){
            $error = 'Error performing query \'<strong>' . $query . '\': ' . mysqli_error($con);
            file_put_contents($errorFilename, $error."\n");
            exit;
        }
        $query = '';
        file_put_contents($progressFilename, ftell($fp)); // save the current file position for 
        $queryCount++;
    }
}

if( feof($fp) ){
    echo 'dump successfully restored!';
}else{
    echo ftell($fp).'/'.filesize($filename).' '.(round(ftell($fp)/filesize($filename), 2)*100).'%'."\n";
    echo $queryCount.' queries processed! please reload or wait for automatic browser refresh!';
}
?>


    </body>
</html>
